# Pangenome Guided Regional Assembly Workflow

This workflow performs pangenome-guided genome assembly for a target test region on HG002 (using nanopore R10 data release by GIAB [here](https://epi2me.nanoporetech.com/giab-2025.01/)). This branch contains files and details on the workflow version used in the long-read giraffe, 2025 paper.


## Getting started

```sh
git clone https://github.com/shlokanegi/pga_workflow.git
git checkout lrg2025-paper
```

## Dependencies

This workflow relies on several tools that must be installed and available in your `PATH`. Although, each rule can also be executed within the containers or conda environments defined for it.

**Required Tools (versions used for the paper):**
*   [`Snakemake`](https://snakemake.readthedocs.io/en/stable/getting_started/installation.html) (v7.28.3)
*   [`vg`](https://github.com/vgteam/vg?tab=readme-ov-file#installation) (v1.68.0)
*   [`samtools`](https://www.htslib.org/) (v1.13)
*   [`minimap2`](https://github.com/lh3/minimap2?tab=readme-ov-file#installation) (v2.24)
*   [`hifiasm`](https://github.com/chhylp123/hifiasm?tab=readme-ov-file#getting-started) (v0.25.0)
*   [`gfatools`](https://github.com/lh3/gfatools?tab=readme-ov-file#getting-started) (v0.5.5)
*   [`seqkit`](https://anaconda.org/bioconda/seqkit) (v2.10.1)
*   `Shasta` - statically linked executable is available [here](/workflow/shasta/shasta)
*   [`vg-anchors`](https://github.com/shlokanegi/vg_anchors/tree/vg-anchors-release-v0.1.0-lrg) (v0.1.0). The config file is available [here](/workflow/vg-anchors/config.ini).

## Configuration

The workflow is configured using the `config/config_ontR10.yaml` file. This file contains paths to input files, tool parameters, and other settings. The config file also contains details on the required format of the inputs.

**Key Configuration Parameters:**
*   `SAMPLE_IDS`: A list of sample IDs to process.
*   `graph_base`: Path to the pangenome graph.
*   `chm13_ref`: Path to the CHM13 reference genome. ([T2T-CHM13v2.0](https://s3-us-west-2.amazonaws.com/human-pangenomics/T2T/CHM13/assemblies/analysis_set/chm13v2.0.fa.gz) was used in the paper)
*   `HG002v101_ref`: Path to the HG002 reference genome. ([HG002v1.0.1](https://s3-us-west-2.amazonaws.com/human-pangenomics/T2T/HG002/assemblies/hg002v1.1.fasta.gz) was used in the paper)
*   `MINIMAP`: Parameters for `minimap2`.
*   `HAPLOTYPE_SAMPLING`: Parameters for haplotype sampling.
*   `vg-anchors_config`: Config file for `vg-anchors` (provided [here](/workflow/vg-anchors/config.ini))
*   `ANALYSEPAF`, `DISPLAYPAF`, `SHASTA`: Paths to binaries (provided [here](/workflow/shasta/)).
*   `TMPDIR`: A temporary directory for intermediate files.
*   `RUN_MODE`: Controls which parts of the workflow are executed (Options: "no_positive_control" and "positive_control_only").
*   `READ_TYPE`: Specifies whether to use raw or error-corrected reads (Options: "ec" and "raw").
*   `region`: Defines the genomic region to be assembled.

## Directory Structure
* `workflow/`: contains the main Snakefile
    * `rules/`: contains Snakemake rule files (`*.smk`) used by the main workflow
    * `envs/`: contains conda environment definitions (`*.yaml`)
    * `scripts/`: contains data processing, and plotting scripts used in the workflow
    * `vg-anchors/`: contains config file for controlling parameters of the `vg-anchors` tool
* `config/`: Contains snakemake configuration file
* `benchmark/`: Runtime and resource usage statistics for individual Snakemake rules
* `logs/`: Standard output and error logs for each rule execution, useful for debugging
* `results_hs/`: Output files generated by the pipeline.


### Running the Workflow with Singularity

Set the `PGA_BASE_DIR` environment variable. This variable is used to bind paths for Singularity. It should be set to a common parent directory that contains both the pga_workflow project and any input data directories.
For example, if your project is at /path/to/pga_workflow and your data is at /path/to/data, you could set PGA_BASE_DIR=/path/to

RECOMMENDED: To run the workflow with the conda environments defined in `/workflow/envs` for rules with the specified `conda` parameter, use:

```bash
export PGA_BASE_DIR=$(pwd) # Or set to your desired base directory
snakemake --use-singularity --singularity-args "-B $PGA_BASE_DIR" --configfile config/config_ontR10.yaml --cores 128 --printshellcmds --conda-frontend conda
```

If you already have all tools installed and in path, run without conda
```sh
snakemake --use-singularity --singularity-args "-B $PGA_BASE_DIR" --configfile config/config_ontR10.yaml --cores 128 --printshellcmds
```

To resume the workflow from where it left off (e.g., after interruption), use:
```sh
snakemake --use-singularity --singularity-args "-B $PGA_BASE_DIR" --configfile config/config_ontR10.yaml --cores 128 --printshellcmds --rerun-incomplete 
## Sometimes, it asks to unlock and then rerun
snakemake --use-singularity --singularity-args "-B $PGA_BASE_DIR" --configfile config/config_ontR10.yaml --cores 128 --printshellcmds --unlock
```
This will rerun any jobs that were incomplete or failed during the previous run.


## Workflow Control with RUN_MODE and READ_TYPE
Different execution modes are controlled by the `RUN_MODE` and `READ_TYPE` parameter in the `config/config_ontR10.yaml` file.

### RUN_MODE Options:
1. **`"no_positive_control"`**: Runs only the sample workflow
2. **`"positive_control_only"`**: Runs only the positive control workflow. Uses the HG002-included graph for analysis

### READ_TYPE Options:
1. **`"raw"`**: Runs with raw reads
2. **`"ec"`**: Run with error-corrected reads generated by Hifiasm 
